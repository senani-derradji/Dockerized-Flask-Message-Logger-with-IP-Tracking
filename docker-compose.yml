version : '3.8'
services:
   db:
      image : mariadb:latest
      restart : always
      networks:
         - backend
      environment :
          MARIADB_ROOT_PASSWORD : ${DB_ROOT_PASSWORD}
          MARIADB_USER : ${DB_USER}
          MARIADB_PASSWORD : ${DB_PASSWORD}
          MARIADB_DATABASE : ${DB_NAME}
      # healthcheck:
      volumes:
         - db_data:/var/lib/mysql
      ports :
          - "3306:3306"
      logging:
          driver: "json-file"
          options:
             max-size: "5m"
             max-file: "2"
   flask_webapp :
      build : ./app
      image : py-db-web-app:v1.0.1
      networks:
         - frontend
         - backend
      depends_on : 
         - db
            # condition: service_healthy      
      expose:
         - "5000"
      
      environment:
         DB_HOST : db
         DB_NAME : ${DB_NAME}
         DB_USER : ${DB_USER}
         DB_PASSWORD : ${DB_PASSWORD}

      logging:
          driver: "json-file"
          options:
             max-size: "5m"
             max-file: "2"
      volumes:
         - /home/sn76/Documents:/app/vlm-web-app:ro

   nginx :
      image : nginx:latest
      restart : always

      networks:
         - frontend
      ports:
         - "80:80"
         - "443:443"
      volumes:
         - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
         - ./nginx/certs:/etc/nginx/certs:ro
      depends_on:
         - flask_webapp

networks:
   frontend : {}
   backend  : 
       internal : true 
volumes:
   db_data : {}